# Backend Code Review - 2025-08-26

## /src/server.ts

1. **Path Resolution Fragility** - Using `process.cwd()` assumes app is always run from project root. Consider using `__dirname` or `import.meta.url` for more reliable path resolution
2. **CORS Configuration Duplication** - Multiple similar CORS configurations could be consolidated into a factory function
3. **Missing Global Error Handling** - No process-level handlers for `uncaughtException` and `unhandledRejection`
4. **Route Mounting Order Issue** - Tag router mounted at root `/` could conflict with other routes. Should use specific path like `/api/tags`
5. **Missing Compression Middleware** - No response compression for better performance. Add `compression` middleware
6. **Environment-Specific Middleware Loading** - All middleware loads regardless of environment. Consider conditional loading
7. **Missing Request Size Limits** - No explicit body size limits set. Add limits to prevent DoS attacks
8. **Logger Configuration** - Basic pino setup without transport configuration. Need environment-specific logging levels

## /src/db/index.ts

1. **Connection Pool Configuration** - Hardcoded pool settings (max: 20, timeouts) should be configurable via environment variables
2. **Missing Connection Retry Logic** - No automatic reconnection mechanism for database failures
3. **Health Check Inefficiency** - Uses generic `SELECT 1` query. Consider more comprehensive health checks
4. **Missing Connection Pool Monitoring** - No metrics for pool usage, active connections, or wait times
5. **Error Type Narrowing** - Generic `Error` type casting loses specific PostgreSQL error information
6. **Missing Prepared Statements** - Not utilizing prepared statements for frequently executed queries
7. **No Query Timeout Configuration** - Database queries can run indefinitely without timeout settings

## /src/api/auth/apiKeyService.ts

1. **Service Coupling** - Creating `TagService` instance in constructor creates tight coupling. Use dependency injection
2. **Transaction Missing** - `createUserWithApiKey` operations should be wrapped in a database transaction
3. **Error Message Leakage** - Error messages expose internal implementation details
4. **Missing Rate Limiting** - No protection against brute force attacks on `validateApiKey`
5. **Synchronous Bcrypt Operations** - Using synchronous bcrypt could block event loop under load
6. **No API Key Expiration** - API keys never expire, creating security risk
7. **Missing Audit Logging** - No audit trail for API key operations
8. **Hardcoded Constants** - Security parameters (SALT_ROUNDS, KEY_LENGTH) should be configurable

## /src/api/stats/statsService.ts

1. **N+1 Query Problem** - Database query inside loop creates performance bottleneck
2. **Memory Leak Risk** - `Promise.all()` with unbounded queries could exhaust memory
3. **Type Safety Issue** - `parseFloat()` without validation could return NaN
4. **Error Differentiation** - Doesn't distinguish between validation and database errors
5. **Transaction Timeout Risk** - Long-running transactions could timeout or lock resources
6. **Resource Management** - Creates `TagService` instance without lifecycle management
7. **Missing Batch Processing** - No chunking for large data uploads
8. **No Idempotency** - Duplicate submissions could create duplicate records

## /src/api/user/userService.ts

1. **String Interpolation Error** - Using `$${` instead of `${` in error messages
2. **Type Safety Issue** - Unsafe `(ex as Error)` assertion without instanceof check
3. **Singleton Anti-Pattern** - Exported singleton makes testing difficult
4. **Missing Pagination** - No pagination for user list queries
5. **No Caching** - Frequently accessed user data not cached
6. **Missing Field Validation** - No validation for user input fields
7. **No Soft Delete** - Hard deletes lose audit trail

## /src/common/middleware/errorHandler.ts

1. **Incomplete Error Handling** - Stores error but doesn't send response, leaving requests hanging
2. **Missing Error Classification** - Doesn't differentiate error types or set appropriate HTTP status codes
3. **No Error Recovery** - No attempt to recover from transient errors
4. **Missing Error Metrics** - No error rate tracking or alerting
5. **Stack Trace Exposure** - Could expose sensitive stack traces in production
6. **No Request Context** - Doesn't capture request details for debugging

## /src/common/middleware/rateLimiter.ts

1. **Security Risk** - Completely disables rate limiting in dev/test environments
2. **Configuration Validation** - No validation for multiplied environment variables
3. **Missing Per-User Limits** - Only global rate limiting, no per-user/API key limits
4. **No Dynamic Adjustment** - Can't adjust limits without restart
5. **Missing Rate Limit Headers** - Doesn't inform clients about rate limit status
6. **No Distributed Rate Limiting** - Won't work correctly with multiple server instances

## /src/common/utils/envConfig.ts

1. **Security Issue** - Critical credentials (ADMIN_API_KEY, SESSION_SECRET) marked as optional
2. **Validation Gap** - No minimum security requirements for secrets
3. **Error Information Leakage** - Could expose sensitive configuration in error logs
4. **Missing CORS Validation** - Wildcard "*" allowed without production warning
5. **No Secret Rotation** - No support for secret rotation without downtime
6. **Missing Environment Validation** - NODE_ENV values not strictly validated
7. **No Configuration Encryption** - Sensitive values stored in plain text

## /src/api/tags/tagService.ts

1. **Missing Input Validation** - Tag names not validated for format/length
2. **Race Condition** - Concurrent tag operations could create duplicates
3. **No Tag Limits** - Users can create unlimited tags
4. **Missing Authorization** - No checks for tag ownership
5. **Inefficient Queries** - Multiple queries where joins would suffice

## /src/api/views/adminViewRouter.ts

1. **Missing CSRF Protection** - Admin routes lack CSRF tokens
2. **No Request Validation** - Form inputs not validated
3. **Template Injection Risk** - User input directly rendered in templates
4. **Missing Access Control** - No role-based permissions
5. **Session Fixation Risk** - Sessions not regenerated after login

## /src/common/middleware/sessionConfig.ts

1. **Insecure Cookie Settings** - Missing `sameSite` and `httpOnly` flags in development
2. **No Session Rotation** - Sessions never rotate, increasing hijacking risk
3. **Missing Session Validation** - No verification of session integrity
4. **No Concurrent Session Limits** - Users can have unlimited sessions
5. **Missing Session Activity Tracking** - No idle timeout implementation

## General Architecture Issues

1. **No Dependency Injection Container** - Services directly instantiate dependencies
2. **Missing Event-Driven Architecture** - Tightly coupled components
3. **No Circuit Breaker Pattern** - External service failures cascade
4. **Missing Health Check Endpoint** - No comprehensive system health monitoring
5. **No Feature Flags** - Can't toggle features without deployment
6. **Missing API Versioning** - Breaking changes affect all clients
7. **No Request Tracing** - Difficult to debug distributed issues
8. **Missing Performance Monitoring** - No APM or custom metrics